#!/bin/bash

# Get the current directory name
DIR_NAME=$(basename "$(pwd)")

# Initialize array for additional volume mounts
VOLUME_MOUNTS=()

# Function to add a read-only mount
add_ro_mount() {
  local path="$1"

  if [[ ! "$path" = /* ]]; then
    echo "Warning: Skipping relative path '$path' (must be absolute)" >&2
    return 1
  fi

  if [[ ! -d "$path" ]]; then
    echo "Warning: Skipping non-existent directory '$path'" >&2
    return 1
  fi

  local dir_name=$(basename "$path")

  VOLUME_MOUNTS+=("-v" "${path}:/external/${dir_name}:ro")
  echo "Mounting: $path -> /external/${dir_name} (read-only)" >&2
}

# Process command-line arguments
for arg in "$@"; do
  add_ro_mount "$arg"
done

# Process LOCALDEV_MOUNTS environment variable
if [[ -n "$LOCALDEV_MOUNTS" ]]; then
  IFS=';' read -ra MOUNT_PATHS <<< "$LOCALDEV_MOUNTS"
  for path in "${MOUNT_PATHS[@]}"; do
    path=$(echo "$path" | xargs)
    if [[ -n "$path" ]]; then
      add_ro_mount "$path"
    fi
  done
fi

# Run container with proper user mapping and dynamic working directory
podman run -it --rm \
  -v "$(pwd):/${DIR_NAME}" \
  -v "$HOME/.claude:/${DIR_NAME}/.claude:ro" \
  "${VOLUME_MOUNTS[@]}" \
  -e HOST_UID=$(id -u) \
  -e HOST_GID=$(id -g) \
  -w "/${DIR_NAME}" \
  localdev:latest \
  bash
