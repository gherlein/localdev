# localfull - Full-featured development container
# Includes Java 17, Atlassian CLI, multiple Node.js versions, and additional tools
# For lightweight container, see Dockerfile (localdev)
FROM docker.io/eclipse-temurin:17-jdk

# Install dependencies
RUN apt-get update && apt-get install -y \
    sudo \
    curl \
    git \
    unzip \
    build-essential \
    squashfs-tools \
    zip \
    file \
    xxd \
    ffmpeg \
    qpdf \
    imagemagick \
    libpcap-dev \
    jq \
    gosu \
    python3 \
    python3-pip \
    tree \
    tmux \
    rsync && rm -rf /var/lib/apt/lists/*

# Install Node.js using nvm to support multiple versions
ENV NVM_DIR=/usr/local/nvm
ENV NODE_VERSION_14=14.16.0
ENV NODE_VERSION_18=18.18.2
ENV NODE_VERSION_LTS=lts/*

RUN mkdir -p $NVM_DIR && \
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash && \
    . $NVM_DIR/nvm.sh && \
    nvm install $NODE_VERSION_14 && \
    nvm install $NODE_VERSION_18 && \
    nvm install $NODE_VERSION_LTS && \
    nvm alias default $NODE_VERSION_LTS && \
    nvm use default

# Add nvm to PATH - source nvm in subsequent RUN commands
ENV NODE_PATH="$NVM_DIR/versions/node"
SHELL ["/bin/bash", "-c"]

# Set PATH to include the default Node.js version installed by nvm
# Also create a symlink for consistent path across node version updates
RUN . $NVM_DIR/nvm.sh && \
    ln -s "$NVM_DIR/versions/node/$(nvm version default)" "$NVM_DIR/default" && \
    echo "export PATH=\"$NVM_DIR/default/bin:\$PATH\"" >> /etc/environment

# Add node to PATH at container level (required for scripts like clauded)
ENV PATH="$NVM_DIR/default/bin:${PATH}"

# Install Podman
RUN apt-get update && apt-get install -y \
    podman \
    uidmap \
    fuse-overlayfs \
    slirp4netns && \
    rm -rf /var/lib/apt/lists/*

# Configure Podman for rootless operation
RUN mkdir -p /etc/containers && \
    echo '[containers]' > /etc/containers/containers.conf && \
    echo 'netns="host"' >> /etc/containers/containers.conf && \
    echo 'userns="host"' >> /etc/containers/containers.conf && \
    echo 'ipcns="host"' >> /etc/containers/containers.conf && \
    echo 'utsns="host"' >> /etc/containers/containers.conf && \
    echo 'cgroupns="host"' >> /etc/containers/containers.conf && \
    echo 'cgroups="disabled"' >> /etc/containers/containers.conf && \
    echo 'devices="/dev/null"' >> /etc/containers/containers.conf && \
    echo '[engine]' >> /etc/containers/containers.conf && \
    echo 'cgroup_manager="cgroupfs"' >> /etc/containers/containers.conf && \
    echo 'events_logger="file"' >> /etc/containers/containers.conf && \
    echo 'runtime="crun"' >> /etc/containers/containers.conf

# Install GitHub CLI
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
    chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
    apt-get update && \
    apt-get install -y gh && \
    rm -rf /var/lib/apt/lists/*

# Install Atlassian CLI using the official APT repository
RUN mkdir -p /etc/apt/keyrings && \
    curl -fsSL https://acli.atlassian.com/gpg/public-key.asc | gpg --dearmor -o /etc/apt/keyrings/acli-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/acli-archive-keyring.gpg] https://acli.atlassian.com/linux/deb stable main" | tee /etc/apt/sources.list.d/acli.list > /dev/null && \
    apt-get update && \
    apt-get install -y acli && \
    rm -rf /var/lib/apt/lists/*

# Install Go
ARG GO_VERSION=1.25.0
ARG TARGETARCH
RUN echo "TARGETARCH: ${TARGETARCH}"
RUN case "${TARGETARCH}" in \
    "amd64") GOARCH=amd64 ;; \
    "arm64") GOARCH=arm64 ;; \
    *) echo "Unsupported architecture: ${TARGETARCH}" && exit 1 ;; \
    esac && \
    curl -fsSL https://dl.google.com/go/go${GO_VERSION}.linux-${GOARCH}.tar.gz | tar --no-same-permissions --no-same-owner -xzC /usr/local

# Set Go environment variables
ENV GOROOT=/usr/local/go
ENV GOPATH=/home/developer/go
ENV PATH="${GOROOT}/bin:${GOPATH}/bin:${PATH}"

# Install TinyGo
ARG TINYGO_VERSION=0.40.1
RUN case "${TARGETARCH}" in \
    "amd64") TINYGO_ARCH=amd64 ;; \
    "arm64") TINYGO_ARCH=arm64 ;; \
    *) echo "Unsupported architecture: ${TARGETARCH}" && exit 1 ;; \
    esac && \
    curl -fsSL "https://github.com/tinygo-org/tinygo/releases/download/v${TINYGO_VERSION}/tinygo_${TINYGO_VERSION}_${TINYGO_ARCH}.deb" -o /tmp/tinygo.deb && \
    dpkg -i /tmp/tinygo.deb && \
    rm /tmp/tinygo.deb

# Create a new user with UID/GID 1000 to match host user
# Handle case where GID 1000 already exists
RUN (groupadd -g 1000 developer 2>/dev/null || groupmod -n developer $(getent group 1000 | cut -d: -f1)) && \
    (useradd -m -u 1000 -g 1000 -s /bin/bash developer 2>/dev/null || \
    usermod -l developer -d /home/developer -m $(getent passwd 1000 | cut -d: -f1) 2>/dev/null || true) && \
    echo 'developer ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

# Fix permissions for developer user
# Note: npm global packages are managed by nvm, not in .npm-global
RUN mkdir -p /home/developer/go/{bin,src,pkg} && \
    chown -R 1000:1000 /home/developer

# Install npm tools in small batches to avoid OOM (exit 137)
# Batch 1: Essential tools (Claude Code uses npx, not global install)
RUN . $NVM_DIR/nvm.sh && \
    NODE_OPTIONS="--max-old-space-size=8192" npm install -g \
    typescript \
    ts-node && \
    npm cache clean --force

# Batch 2: Build tools
RUN . $NVM_DIR/nvm.sh && \
    NODE_OPTIONS="--max-old-space-size=8192" npm install -g \
    webpack \
    webpack-cli \
    webpack-dev-server \
    esbuild && \
    npm cache clean --force

# Batch 3: Development tools
RUN . $NVM_DIR/nvm.sh && \
    NODE_OPTIONS="--max-old-space-size=8192" npm install -g \
    nodemon \
    npm-check-updates \
    pnpm && \
    npm cache clean --force

# Batch 4: Code quality tools
RUN . $NVM_DIR/nvm.sh && \
    NODE_OPTIONS="--max-old-space-size=8192" npm install -g \
    eslint \
    prettier && \
    npm cache clean --force

# Batch 5: Testing tools (split to avoid OOM)
RUN . $NVM_DIR/nvm.sh && \
    NODE_OPTIONS="--max-old-space-size=4096" npm install -g \
    jest && \
    npm cache clean --force

RUN . $NVM_DIR/nvm.sh && \
    NODE_OPTIONS="--max-old-space-size=4096" npm install -g \
    vitest && \
    npm cache clean --force

# Batch 6: PDF and other tools
RUN . $NVM_DIR/nvm.sh && \
    NODE_OPTIONS="--max-old-space-size=8192" npm install -g \
    md-to-pdf \
    pdf2md \
    @github/copilot && \
    npm cache clean --force

# Install Homebrew
RUN /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Add Homebrew to PATH
ENV PATH="/home/linuxbrew/.linuxbrew/bin:${PATH}"

# install Marp CLI
RUN brew install marp-cli

# Install Hugo Extended static site generator
ARG HUGO_VERSION=0.146.0
RUN HUGO_ARCH=$(dpkg --print-architecture) && \
    curl -fsSL https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-${HUGO_ARCH}.deb -o /tmp/hugo.deb && \
    dpkg -i /tmp/hugo.deb && \
    rm /tmp/hugo.deb

# Install memory-heavy mermaid-cli separately with increased memory limit
# and retry logic in case of OOM
RUN . $NVM_DIR/nvm.sh && \
    NODE_OPTIONS="--max-old-space-size=4096" npm install -g @mermaid-js/mermaid-cli || \
    (echo "First attempt failed, cleaning cache and retrying..." && \
    npm cache clean --force && \
    NODE_OPTIONS="--max-old-space-size=4096" npm install -g @mermaid-js/mermaid-cli) || \
    echo "Warning: Failed to install mermaid-cli (requires more memory)"

# Setup lazy-load nvm in bash for all users (loads on first use for faster startup)
RUN echo 'export NVM_DIR=/usr/local/nvm' >> /etc/bash.bashrc && \
    echo '# Lazy-load nvm for faster shell startup' >> /etc/bash.bashrc && \
    echo 'nvm() { unset -f nvm node npm npx; . "$NVM_DIR/nvm.sh"; nvm "$@"; }' >> /etc/bash.bashrc && \
    echo 'node() { unset -f nvm node npm npx; . "$NVM_DIR/nvm.sh"; node "$@"; }' >> /etc/bash.bashrc && \
    echo 'npm() { unset -f nvm node npm npx; . "$NVM_DIR/nvm.sh"; npm "$@"; }' >> /etc/bash.bashrc && \
    echo 'npx() { unset -f nvm node npm npx; . "$NVM_DIR/nvm.sh"; npx "$@"; }' >> /etc/bash.bashrc && \
    echo '# Add default node to PATH for non-interactive use' >> /etc/bash.bashrc && \
    echo 'export PATH="$NVM_DIR/versions/node/$(cat $NVM_DIR/alias/default 2>/dev/null || echo "v22")/bin:$PATH" 2>/dev/null || true' >> /etc/bash.bashrc

# Claude Code is installed via native installer after switching to developer user

# Repeat for copilot
RUN echo 'alias copilotd="claude --allow-all-tools"' >> /etc/bash.bashrc

# Note: NPM_CONFIG_PREFIX is NOT set because we use nvm to manage npm
# nvm already configures PATH correctly for npm global packages
# Global npm packages installed via nvm are in: $NVM_DIR/versions/node/<version>/bin

WORKDIR /workspace

# Install udev and USB libraries for device access
RUN apt-get update && apt-get install -y \
    udev \
    libusb-1.0-0 \
    libusb-1.0-0-dev \
    usbutils \
    && rm -rf /var/lib/apt/lists/*

# Switch to developer user
USER developer

# Install Claude Code using native installer
RUN curl -fsSL https://claude.ai/install.sh | bash

# Create clauded wrapper for dangerously-skip-permissions mode
RUN mkdir -p "$HOME/.local/bin" && \
    echo '#!/bin/bash' > "$HOME/.local/bin/clauded" && \
    echo 'exec claude --dangerously-skip-permissions "$@"' >> "$HOME/.local/bin/clauded" && \
    chmod +x "$HOME/.local/bin/clauded"

# install uv with retry logic
RUN for i in 1 2 3; do \
    curl -LsSf https://astral.sh/uv/install.sh | sh && break || \
    (echo "Attempt $i failed, retrying..." && sleep 5); \
    done

# Add uv to PATH
ENV PATH="/home/developer/.local/bin:${PATH}"

# Install md2pdf
RUN /home/developer/.local/bin/uv tool install md2pdf

# Install Go development tools and linters (split into groups for better reliability)
RUN go install golang.org/x/tools/cmd/goimports@latest && \
    go install golang.org/x/tools/cmd/godoc@latest && \
    go install mvdan.cc/gofumpt@latest && \
    go install golang.org/x/vuln/cmd/govulncheck@latest

RUN go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest && \
    go install honnef.co/go/tools/cmd/staticcheck@latest && \
    go install github.com/go-delve/delve/cmd/dlv@latest

RUN go install github.com/fatih/gomodifytags@latest && \
    go install github.com/josharian/impl@latest && \
    go install github.com/cweill/gotests/gotests@latest && \
    go install github.com/google/wire/cmd/wire@latest

# Install remaining tools (skip problematic ones if they fail)
RUN go install github.com/segmentio/golines@latest || echo "Warning: Failed to install golines" && \
    go install github.com/golang/mock/mockgen@latest || echo "Warning: Failed to install mockgen"

# Install Protocol Buffer tools (buf, protoc-gen-go)
RUN go install github.com/bufbuild/buf/cmd/buf@latest && \
    go install google.golang.org/protobuf/cmd/protoc-gen-go@latest

# Install NATS server and CLI
RUN go install github.com/nats-io/nats-server/v2@latest && \
    go install github.com/nats-io/natscli/nats@latest

# Install Go development utilities (air, pkgsite, stress)
RUN go install github.com/air-verse/air@latest && \
    go install golang.org/x/pkgsite/cmd/pkgsite@latest && \
    go install golang.org/x/tools/cmd/stress@latest

CMD ["/bin/bash"]
